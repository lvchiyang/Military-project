# 后端架构设计详细说明

## 1. 后端总体架构

### 1.1 架构原则
- **模块化设计**：各模块职责明确，低耦合高内聚
- **数据驱动**：基于配置文件驱动业务流程
- **事件驱动**：通过事件机制实现模块间通信
- **多线程支持**：每个项目独立线程执行
- **可扩展性**：支持新增业务模块和指标

### 1.2 技术栈选型

| 技术领域 | 技术选择 | 说明 |
|---------|----------|------|
| 运行时 | Node.js | 跨平台JavaScript运行环境 |
| Web框架 | Express.js | 轻量级Web应用框架 |
| 数据库 | SQLite | 嵌入式数据库，适合桌面应用 |
| ORM | Sequelize | Node.js ORM框架 |
| 任务调度 | node-cron | 定时任务调度 |
| 文件处理 | multer + mammoth | 文件上传和文档解析 |
| 进程通信 | EventEmitter | Node.js事件系统 |
| 日志系统 | winston | 结构化日志记录 |

### 1.3 架构层次图

```
┌─────────────────────────────────────────────────────────────┐
│                    API接口层                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   项目API   │ │   员工API   │ │   数据API   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                    业务逻辑层                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   项目管理   │ │   流程引擎   │ │   员工管理   │          │
│  │   服务      │ │   服务      │ │   服务      │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   指标计算   │ │   文件管理   │ │   事件处理   │          │
│  │   服务      │ │   服务      │ │   服务      │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                    数据访问层                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   数据模型   │ │   仓储接口   │ │   数据库连接  │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│                    数据存储层                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   SQLite    │ │   文件系统   │ │   配置文件   │          │
│  │   数据库    │ │   存储      │ │   管理      │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 2. 核心模块设计

### 2.1 项目管理模块 (ProjectManager)

**职责**：
- 项目生命周期管理
- 项目配置和状态维护
- 多项目并发控制
- 项目数据持久化

**核心接口定义**：

项目管理接口：
- 项目创建、删除、暂停、恢复
- 项目查询（单个、全部、按状态筛选）
- 项目状态更新、进度更新
- 项目事件处理

项目实体结构：
- 基本信息：ID、名称、描述、状态、当前阶段、进度
- 预算信息：总额、已用、剩余、日成本
- 团队信息：员工列表
- 配置信息：项目配置
- 时间信息：创建时间、更新时间

项目操作方法：
- 项目控制：开始、暂停、恢复、完成
- 阶段管理：获取当前阶段、移动到下一阶段
- 团队管理：分配员工、移除员工
- 预算管理：消耗预算、获取剩余预算

项目配置接口：
- 基本信息：名称、描述、预算
- 资源模板：资源模板选择
- 时间倍率：时间加速倍数
- 阶段配置：各阶段详细配置

预算结构：
- 总额、已用、剩余、日成本

**数据模型**：

项目表结构：
- 主键ID、项目名称、描述
- 状态（待开始/运行中/暂停/已完成）
- 当前阶段（研/建/用/管/维）
- 进度百分比、预算总额、已用预算
- 时间倍率、配置信息（JSON格式）
- 创建时间、更新时间

项目团队表结构：
- 主键ID、项目ID、员工ID
- 角色、分配时间
- 外键关联项目和员工表

### 2.2 流程引擎模块 (ProcessEngine)

**职责**：
- 项目流程定义和执行
- 任务调度和状态管理
- 事件触发和处理
- 流程配置解析
- 手动/自动执行模式控制

**执行模式设计**：
- **手动模式**：所有任务进展需要用户手动点击触发
- **自动模式**：系统自动填充任务数据和进度，但需用户确认后才正式更新
- **混合模式**：自动执行基础流程，允许用户随时手动干预和调整
- 自动模式下系统会生成数据预览，用户可选择确认、修改或重新生成

**核心类设计**：

流程引擎接口：
- 流程定义管理：加载流程定义、注册流程定义
- 流程实例管理：启动、暂停、恢复、终止流程
- 任务执行：执行任务、完成任务
- 事件处理：触发事件、处理事件

流程实例结构：
- 基本信息：ID、项目ID、定义ID、状态
- 当前状态：当前阶段、当前任务
- 变量存储：流程变量映射
- 流程控制：移动到下一任务/阶段、回滚到指定任务
- 变量操作：设置变量、获取变量

任务调度器接口：
- 任务调度：调度任务、执行下一任务、取消任务
- 任务监控：获取任务状态、队列任务、执行中任务

流程定义结构：
- 基本信息：ID、名称、版本
- 阶段定义：阶段列表
- 事件定义：事件列表
- 变量定义：变量列表

阶段定义结构：
- 基本信息：ID、名称、显示名称
- 任务列表：任务定义列表
- 条件定义：条件列表

任务定义结构：
- 基本信息：ID、名称、类型、持续时间
- 角色要求：所需角色
- 依赖关系：依赖任务列表
- 事件列表：关联事件列表
- 脚本：可执行脚本（可选）

**任务事件模板设计**：
- 基于《研建用管维角色关系与效能指标体系分析.md》中的17个关键任务
- 每个任务细化为具体的事件序列，如编码实现包含：代码框架搭建→核心功能开发→代码提交→单元测试→代码审查→分支合并→构建验证
- 支持事件失败和重试机制，如构建失败→问题修复→重新构建
- 每个事件都有明确的持续时间和对效能指标的影响值

**流程配置文件格式**：

流程定义JSON结构：
- 基本信息：ID、名称、版本
- 阶段列表：每个阶段包含任务定义
- 任务定义：任务ID、名称、类型、持续时间、所需角色、依赖关系、事件列表
- 事件定义：事件类型、描述、指标影响、脚本调用
- 全局事件：预算不足、需求变更等系统级事件
- 指标影响：每个事件对效能指标的具体影响值

### 2.3 员工管理模块 (EmployeeManager)

**职责**：
- 员工信息管理
- 任务分配和调度
- 工资计算和预算扣除
- 绩效评估和积分管理

**核心类设计**：

员工管理接口：
- 员工管理：创建、更新、删除员工
- 员工查询：按ID、角色、可用状态查询
- 任务分配：分配任务、取消分配、重新分配
- 工资和绩效：计算日薪、更新积分、获取绩效
- 状态管理：更新员工状态、获取工作负载

员工实体结构：
- 基本信息：ID、姓名、角色、状态
- 能力信息：效率系数、日薪、总积分
- 任务信息：当前任务、已完成任务
- 技能信息：技能列表、经验值
- 任务管理：分配任务、完成任务、获取工作负载
- 绩效计算：计算效率、更新积分、获取绩效指标

员工配置接口：
- 基本信息：姓名、角色、日薪
- 能力参数：效率系数、技能列表、经验值

绩效结构：
- 任务统计：总任务数、已完成任务数
- 时间统计：平均完成时间
- 质量统计：质量评分、效率、总积分

员工角色枚举：
- 研、建、用、管、维五种角色

员工状态枚举：
- 空闲、工作中、离线三种状态

**任务分配策略**：

分配策略接口：
- 任务分配方法：根据任务和可用员工列表分配员工

基于技能的分配策略：
- 匹配逻辑：基于技能匹配度确定最佳员工
- 评分计算：效率系数40% + 经验30% + 技能匹配30%
- 候选筛选：按角色匹配、状态筛选、技能匹配排序

负载均衡分配策略：
- 分配逻辑：基于工作负载平衡分配任务
- 候选筛选：按角色匹配、按工作负载排序

### 2.4 指标计算模块 (MetricsCalculator)

**职责**：
- 40个效能指标的定义和计算
- 实时指标更新
- 指标历史数据管理
- 异常检测和告警

**指标计算逻辑**：
- 基于《研建用管维角色关系与效能指标体系分析.md》中定义的指标公式
- 每个任务事件完成时触发相关指标的重新计算
- 支持指标间的依赖关系计算，如综合效能指数依赖多个子指标
- 提供指标阈值设置和异常告警机制

**核心类设计**：

指标计算器接口：
- 指标定义管理：注册指标定义、获取指标定义
- 指标计算：计算单个指标、计算所有指标、更新指标
- 指标查询：获取指标值、获取指标历史、按分类获取指标
- 异常检测：检查告警、评估告警规则

指标定义结构：
- 基本信息：ID、名称、描述、分类、单位、类型
- 计算信息：计算公式、依赖关系、告警规则

指标值结构：
- 基本信息：指标ID、项目ID、值、时间戳
- 趋势信息：趋势类型、变化百分比

指标分类：
- 质量指标、进度指标、成本指标、风险指标、效率指标

指标类型：
- 计数器、仪表盘、直方图、摘要

**40个效能指标定义**：

质量指标（10个）：
- 需求完成度：已完成需求/总需求 * 100%
- 缺陷密度：总缺陷数/(代码行数/1000)
- 代码覆盖率：(覆盖行数/总行数) * 100%
- 评审效率：评审项目数/评审时间

进度指标（10个）：
- 进度绩效指数：挣值/计划值
- 里程碑完成率：(已完成里程碑/总里程碑) * 100%
- 任务完成率：(已完成任务/总任务) * 100%
- 开发速度：已完成故事点/迭代次数

成本指标（10个）：
- 成本绩效指数：挣值/实际成本
- 预算使用率：(已用预算/总预算) * 100%
- 每缺陷成本：总成本/总缺陷数

风险指标（10个）：
- 风险暴露度：风险概率 * 风险影响的求和
- 技术债务比率：(技术债务成本/开发成本) * 100%

### 2.5 文件管理模块 (FileManager)

**职责**：
- 文件上传和存储
- 文档解析和处理
- 里程碑文件生成
- 文件版本管理

**核心类设计**：

文件管理接口：
- 文件上传：单文件上传、多文件上传
- 文件下载：单文件下载、项目文件打包下载（ZIP格式）
- 文档解析：解析文档内容、提取需求信息
- 里程碑管理：生成里程碑文件、获取里程碑列表
- 文件管理：获取文件信息、删除文件、获取项目文件

文件信息结构：
- 基本信息：ID、原始名称、文件名、路径、大小、MIME类型
- 关联信息：项目ID、上传时间、文件分类

文档内容结构：
- 基本信息：标题、内容
- 结构化信息：章节列表、需求列表、元数据

里程碑文件结构：
- 基本信息：ID、项目ID、阶段、名称、描述
- 交付物：交付物列表、文件路径、创建时间

文件分类：
- 需求文档、设计文档、代码文件、测试文件、里程碑文档、其他

### 2.6 事件处理模块 (EventHandler)

**职责**：
- 系统事件定义和处理
- 事件路由和分发
- 事件持久化存储
- 事件驱动的业务逻辑
- 意外事件模拟和处理

**意外事件管理逻辑**：
- **需求变更事件**：在研发和建设阶段随机触发，影响进度和成本
- **严重Bug发现**：在使用和管理阶段触发，启动紧急维护流程
- **人员短缺事件**：在建设和管理阶段触发，需要重新分配资源
- **技术难题事件**：在建设阶段触发，可能延长开发时间但提升质量
- 每种事件都有概率设置、影响系数和应对措施定义

**其他开销计算逻辑**：
- **固定开销**：办公室租金、设备折旧、软件许可等，每日固定扣除
- **变动开销**：水电费、通讯费等，根据团队规模计算
- **偶发开销**：培训费用、会议成本等，按概率随机发生
- 所有开销都会从项目预算中实时扣除，影响项目可持续性

**核心类设计**：

事件处理器接口：
- 事件注册：注册事件处理器、注销事件处理器
- 事件发布：发布单个事件、批量发布事件
- 事件处理：处理事件、执行处理器
- 事件查询：获取事件列表、按类型获取事件

系统事件结构：
- 基本信息：ID、类型、项目ID、时间戳
- 关联信息：任务ID、员工ID、数据、来源、元数据

事件处理器函数：
- 异步事件处理函数

事件类型定义：
- 项目事件：创建、启动、暂停、完成
- 任务事件：分配、开始、完成、失败
- 员工事件：分配、状态变更
- 指标事件：更新、告警
- 文件事件：上传、解析、生成里程碑
- 异常事件：预算不足、需求变更、Bug发现

## 3. 数据层设计

### 3.1 数据模型定义

**使用Sequelize ORM定义数据模型**：

项目模型：
- 基本信息：ID、名称、描述、状态、当前阶段、进度
- 预算信息：预算总额、已用预算、时间倍率
- 配置信息：JSON格式配置
- 时间信息：创建时间、更新时间

员工模型：
- 基本信息：ID、姓名、角色、状态
- 能力信息：效率、日薪、总积分
- 技能信息：技能列表（JSON数组）、经验值
- 时间信息：创建时间、更新时间

任务模型：
- 基本信息：ID、项目ID、名称、阶段、类型、持续时间
- 分配信息：所需角色、分配员工ID
- 状态信息：状态、进度、开始时间、结束时间
- 配置信息：依赖关系（JSON数组）、配置（JSON）

指标模型：
- 基本信息：ID、项目ID、指标ID、指标名称、分类
- 值信息：值（支持数字和字符串）、单位、趋势、变化百分比
- 时间信息：记录时间

事件模型：
- 基本信息：ID、类型、项目ID、任务ID、员工ID、时间戳
- 数据信息：数据（JSON）、来源、元数据（JSON）

### 3.2 数据访问层 (Repository)

**仓储模式实现数据访问**：

项目仓储接口：
- 基本操作：创建、按ID查找、查找全部、更新、删除
- 查询操作：按状态查找项目

项目仓储实现：
- 创建项目：将业务实体转换为数据库模型并保存
- 按ID查找：包含关联的团队和任务信息
- 实体映射：将数据库模型转换为业务实体
- 关联查询：包含员工和任务的关联查询

## 4. API接口设计

### 4.1 RESTful API设计

**项目管理API**：

项目CRUD操作：
- POST /：创建项目
- GET /：获取所有项目
- GET /:id：获取单个项目
- PUT /:id：更新项目
- DELETE /:id：删除项目

项目控制操作：
- POST /:id/start：启动项目
- POST /:id/pause：暂停项目
- POST /:id/resume：恢复项目
- POST /:id/complete：完成项目

项目数据查询：
- GET /:id/metrics：获取项目指标
- GET /:id/tasks：获取项目任务
- GET /:id/team：获取项目团队
- GET /:id/milestones：获取项目里程碑
- GET /:id/events：获取项目事件

**项目控制器**：

控制器功能：
- 项目创建：接收项目配置，调用项目管理器创建项目
- 项目查询：按ID查询项目，处理不存在情况
- 项目启动：调用项目管理器启动项目
- 错误处理：统一的错误响应格式

响应格式：
- 成功响应：包含success标志、数据和消息
- 错误响应：包含success标志和错误信息

### 4.2 WebSocket实时通信

**实时数据推送**：

WebSocket服务器功能：
- 服务器初始化：配置CORS、设置事件处理器和Socket处理器
- 事件处理器设置：监听系统事件并推送给客户端
- Socket处理器设置：处理客户端连接、加入/离开项目房间

事件推送类型：
- 指标更新：推送到项目房间
- 任务完成：推送任务完成信息
- 项目状态变更：推送项目状态变化

客户端交互：
- 连接处理：记录客户端连接
- 房间管理：加入/离开项目房间
- 断开处理：记录客户端断开

广播功能：
- 项目广播：向指定项目的所有客户端广播消息

## 5. 多线程项目执行

### 5.1 项目线程管理

**项目执行线程**：

项目线程功能：
- 线程状态管理：运行状态、暂停状态、执行间隔
- 线程控制：启动、暂停、恢复、停止
- 执行循环：每秒检查一次项目状态
- 任务执行：获取当前任务、执行任务、完成任务

执行步骤：
- 项目状态检查：检查项目是否存在
- 预算检查：检查预算是否充足
- 任务获取：获取当前任务
- 阶段推进：无任务时移动到下一阶段
- 任务执行：分配员工、更新进度、扣除预算、更新指标

任务执行逻辑：
- 员工分配：为任务分配合适的员工
- 进度更新：根据员工效率和时间倍率更新进度
- 预算扣除：按小时扣除员工成本
- 指标更新：更新相关效能指标
- 完成检查：检查任务是否完成

任务完成处理：
- 状态更新：设置任务状态为已完成
- 员工积分：更新员工积分
- 事件发布：发布任务完成事件

**项目线程管理器**：

管理器功能：
- 线程管理：启动、暂停、恢复、停止项目线程
- 状态跟踪：跟踪运行中的项目
- 并发控制：防止重复启动项目

## 6. 配置和扩展性

### 6.1 配置管理

**系统配置**：

配置结构：
- 数据库配置：路径、最大连接数、超时时间
- 服务器配置：端口、主机、CORS设置
- 指标配置：更新间隔、告警阈值、历史保留时间
- 文件配置：文件存储设置
- AI配置：AI服务配置

配置管理器功能：
- 配置加载：从配置文件加载系统配置
- 配置获取：获取嵌套配置值
- 配置设置：设置配置值并保存
- 配置保存：将配置保存到文件

### 6.2 插件系统

**插件接口**：

插件结构：
- 基本信息：名称、版本
- 生命周期：初始化、销毁
- 上下文：事件处理器、指标计算器、项目管理器、配置

插件管理器功能：
- 插件加载：动态加载插件模块
- 插件初始化：使用上下文初始化插件
- 插件卸载：销毁插件并清理资源
- 插件查询：获取已加载的插件列表

## 7. 日志和监控

### 7.1 日志系统

日志系统功能：
- 日志级别：info、error、warn、debug
- 日志格式：时间戳、错误堆栈、JSON格式
- 日志输出：文件输出（错误日志、综合日志）、控制台输出
- 日志方法：info、error、warn、debug

### 7.2 性能监控

性能监控功能：
- 计时器：开始计时、结束计时
- 指标记录：记录性能指标值
- 指标查询：获取所有性能指标
- 报告生成：生成性能报告

性能报告结构：
- 时间戳：报告生成时间
- 指标统计：平均值、最小值、最大值、计数、单位

计时器功能：
- 开始计时：记录开始时间
- 结束计时：计算持续时间并记录指标

## 8. 总结

本后端架构设计采用模块化、事件驱动的设计理念，具有以下特点：

1. **清晰的分层架构**：API层、业务逻辑层、数据访问层、存储层职责明确
2. **高度模块化**：各模块独立开发、测试和维护
3. **事件驱动**：通过事件机制实现松耦合的模块通信
4. **多线程支持**：每个项目独立执行，支持并发处理
5. **配置驱动**：业务流程和规则通过配置文件定义
6. **可扩展性**：支持插件系统和自定义指标
7. **实时通信**：WebSocket支持实时数据推送
8. **完整的监控**：日志、性能监控和异常处理

该架构能够满足"研建用管维"演示验证系统的所有功能需求，为前端提供稳定可靠的数据服务和业务支撑。